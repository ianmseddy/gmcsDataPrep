---
title: "historical PSP climate data"
author: ""
date: "Jan 15 2023"
output: pdf_document
---

# Overview

The purpose of this code is to generate the inputs to climateNA needed to produce historical climate data for each PSP plot. The PSP data should be obtained without restrictions on plot criteria (e.g. no filtering for MPB damage, min. DBH)
so that the availability of historical climate data is not a limiting factor when using these data in other modules. 
When elevation data is not present for a given plot, it is estimated from a DEM (7.5 arc-second). This approach was determined to be a large improvement over running climateNA with no elevation data. 


```{generating inputs to ClimateNA}
library(terra)
library(sf)
library(reproducible)
library(PSPclean)
library(LandR)

dPath <- tempdir()# adjust as needed
PSPs <- PSPclean::getPSP(PSPdataTypes = "all", destinationPath = dPath, forGMCS = FALSE)
PSPloc <- PSPs$PSPgis
rm(PSPs)
#get an elevation DEM - this is the 7.5 arcsecond DEM used for fireSense, from GTOPO
CanadaDEM <- prepInputs(url = "https://drive.google.com/file/d/121x_CfWy2XP_-1av0cYE7sxUfb4pmsup/view?usp=sharing", 
                        destinationPath = tempdir())

missingElev <- PSPloc[is.na(PSPloc$Elevation) | PSPloc$Elevation == -1,]
estimatedElev <- data.table(OrigPlotID1 = missingElev$OrigPlotID1,
                            estimatedElevation = extract(CanadaDEM, missingElev, ID = FALSE))
setnames(estimatedElev, new = c("OrigPlotID1", "estimatedElevation"))

PSPcoord <- as.data.table(st_coordinates(PSPloc))
PSPcoord[, OrigPlotID1 := PSPloc$OrigPlotID1]
PSPcoord[, Elevation := PSPloc$Elevation]

PSPcoord <- estimatedElev[PSPcoord, on = c("OrigPlotID1")]
PSPcoord[OrigPlotID1 %in% missingElev$OrigPlotID1, Elevation := estimatedElevation]
#confirm no NA - 
# summary(PSPcoord)
PSPcoord[, estimatedElevation := NULL]

#prep for climateNA
#the columns have to be called "id1", "id2", "lat", "long", "elev"
# sampleData <- fread("C:/users/ieddy/Downloads/ClimateNA_v640/inputFiles/input_test.csv")
setnames(PSPcoord, c("OrigPlotID1", "X", "Y", "Elevation"), 
         c("id1", "long", "lat", "elev"))
PSPcoord[, id2 := ""]
setcolorder(PSPcoord, neworder = c("id1", "id2", "lat", "long", "elev"))

write.csv(PSPcoord, "inputs/PSPforClimateNA_BC_AB_SK_ON_NB_NFI.csv", row.names = FALSE)
```
